import { useState, useEffect } from "react";
import { motion, Reorder, AnimatePresence } from "framer-motion";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import { Trash2, GripVertical, PlusCircle, Copy, RotateCcw, Clock, ShieldCheck, Zap } from "lucide-react";

const LANES_CONFIG = [
  { id: "hotel", title: "نقاط وحدات اعلى الاوتيل" },
  { id: "paleto", title: "نقاط وحدات نقطة بوليتو" },
  { id: "los", title: "نقاط وحدات نقطة لوس" },
  { id: "electric", title: "نقاط وحدات نقطة الكهرب" },
  { id: "grapeseed", title: "نقاط وحدات ثغرة قرابسيد" },
  { id: "lake", title: "نقاط وحدات ثغرة البحيرة" }
];

export default function Home() {
  const { toast } = useToast();
  const [form, setForm] = useState({
    opsName: "",
    opsDeputy: "",
    leaders: "",
    officers: "",
    ncos: "",
    periodOfficer: "",
    notes: "",
    handoverTo: "",
    recvTime: "",
    handoverTime: ""
  });

  const [lanes, setLanes] = useState<Record<string, { id: string, text: string }[]>>(() => {
    const initial: any = {};
    LANES_CONFIG.forEach(l => initial[l.id] = []);
    return initial;
  });

  const [extractedInput, setExtractedInput] = useState("");

  const handleInputChange = (field: string, value: string) => {
    setForm(prev => ({ ...prev, [field]: value }));
  };

  const setTimeNow = (field: "recvTime" | "handoverTime") => {
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const strTime = `${hours}:${minutes} ${ampm}`;
    handleInputChange(field, strTime);
  };

  const addUnit = (laneId = LANES_CONFIG[0].id) => {
    const newUnit = { id: Math.random().toString(36).substr(2, 9), text: "" };
    setLanes(prev => ({
      ...prev,
      [laneId]: [newUnit, ...prev[laneId]]
    }));
  };

  const updateUnitText = (laneId: string, unitId: string, text: string) => {
    setLanes(prev => ({
      ...prev,
      [laneId]: prev[laneId].map(u => u.id === unitId ? { ...u, text } : u)
    }));
  };

  const deleteUnit = (laneId: string, unitId: string) => {
    setLanes(prev => ({
      ...prev,
      [laneId]: prev[laneId].filter(u => u.id !== unitId)
    }));
  };

  const distributeUnits = (laneId: string) => {
    if (!extractedInput.trim()) return;
    const codes = extractedInput.replace(/[،,]/g, ' ').split(/\s+/).filter(Boolean);
    const newUnits = codes.map(text => ({ id: Math.random().toString(36).substr(2, 9), text }));
    setLanes(prev => ({
      ...prev,
      [laneId]: [...prev[laneId], ...newUnits]
    }));
    setExtractedInput("");
    toast({ 
      title: "توزيع ناجح", 
      description: `تم إلحاق ${codes.length} وحدات إلى ${LANES_CONFIG.find(l => l.id === laneId)?.title}` 
    });
  };

  const buildReport = () => {
    const dashList = (t: string) => t.split("\n").map(s => s.trim()).filter(Boolean).join(" - ");
    const lines = [
      `اسم العمليات : ${form.opsName || "-"}`,
      `نائب العمليات : ${form.opsDeputy || "-"}`,
      "",
      `قيادات : ${dashList(form.leaders) || "-"}`,
      `ضباط : ${dashList(form.officers) || "-"}`,
      `ضباط صف : ${dashList(form.ncos) || "-"}`,
      "",
      `مسؤول الفتره : ${dashList(form.periodOfficer) || "-"}`,
      "",
      "توزيع الوحدات :",
      ""
    ];

    LANES_CONFIG.forEach(lane => {
      const units = lanes[lane.id].map(u => u.text.trim()).filter(Boolean);
      lines.push(`| ${lane.title} |`);
      lines.push(units.join(", ") || "-");
      lines.push("");
    });

    lines.push(
      "الملاحظات :", 
      form.notes || "-", 
      "", 
      `وقت الاستلام : ${form.recvTime || "-"}`, 
      `وقت التسليم : ${form.handoverTime || "-"}`, 
      `تم التسليم إلى : ${form.handoverTo || "-"}`
    );
    return lines.join("\n");
  };

  const copyReport = async () => {
    await navigator.clipboard.writeText(buildReport());
    toast({ title: "تم النسخ بنجاح" });
  };

  return (
    <div className="min-h-screen bg-[#0b0805] text-[#f7f2e6] selection:bg-[#d8b24a]/30" dir="rtl">
      {/* Immersive Background */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        <motion.div 
          className="absolute inset-0 bg-[url('/tactical_bg.png')] bg-cover bg-center opacity-10"
          animate={{ scale: [1, 1.05, 1] }}
          transition={{ duration: 20, repeat: Infinity, ease: "linear" }}
        />
        <div className="absolute inset-0 bg-gradient-to-b from-[#0b0805] via-transparent to-[#0b0805]" />
        <div className="scanline" />
      </div>

      <div className="relative z-10 p-4 md:p-8 overflow-y-auto min-h-screen">
        {/* Animated Header */}
        <header className="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-8 mb-16 p-10 rounded-[3.5rem] bg-gradient-to-b from-[#1c160e]/95 to-[#0b0805]/95 border border-[#d8b24a]/20 shadow-[0_30px_100px_rgba(0,0,0,0.8)] backdrop-blur-3xl">
          <motion.div 
            className="flex items-center gap-8"
            initial={{ x: 100, opacity: 0 }}
            animate={{ x: 0, opacity: 1 }}
            transition={{ duration: 0.8 }}
          >
            <motion.div 
              className="relative p-2"
              animate={{ rotateY: [0, 180, 360], scale: [1, 1.1, 1] }}
              transition={{ duration: 10, repeat: Infinity, ease: "linear" }}
            >
               <img src="/army_logo.png" className="w-28 h-28 drop-shadow-[0_0_30px_rgba(216,178,74,0.6)]" alt="Logo" />
            </motion.div>
            <div className="space-y-2">
              <motion.h1 
                className="text-5xl md:text-6xl font-black bg-gradient-to-b from-[#f7f2e6] via-[#f1d58a] to-[#d8b24a] bg-clip-text text-transparent drop-shadow-lg"
                animate={{ opacity: [0.8, 1, 0.8] }}
                transition={{ duration: 3, repeat: Infinity }}
              >
                تحديث مركز العمليات للجيش
              </motion.h1>
              <div className="flex items-center gap-3 text-[#d8b24a]/60 font-display tracking-[0.6em]">
                <ShieldCheck className="w-4 h-4" /> 
                <span className="text-[10px] md:text-xs">MILITARY ENCRYPTION ACTIVE</span>
              </div>
            </div>
          </motion.div>
          <div className="flex gap-4">
            <Button onClick={() => window.location.reload()} variant="outline" className="rounded-2xl border-[#d8b24a]/30 text-[#d8b24a] hover:bg-[#d8b24a]/10 px-10 h-16 text-lg font-black transition-all hover:scale-105 active:scale-95 shadow-xl">
              <RotateCcw className="w-6 h-6 ml-3" /> إعادة الضبط
            </Button>
          </div>
        </header>

        <main className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-10 pb-20">
          {/* Controls Column */}
          <div className="lg:col-span-5 space-y-10">
            <Card className="p-10 bg-[#120d09]/90 border-[#d8b24a]/20 backdrop-blur-3xl rounded-[3rem] shadow-2xl border-t-8 border-t-[#d8b24a]">
              <h2 className="text-3xl font-black text-[#d8b24a] mb-10 flex items-center gap-4">
                <div className="p-3 bg-[#d8b24a]/10 rounded-2xl"><ShieldCheck className="w-8 h-8" /></div>
                بيانات القيادة
              </h2>
              <div className="space-y-8">
                <div className="grid grid-cols-2 gap-6">
                  <div className="space-y-3">
                    <label className="text-xs font-black text-[#d8b24a]/50 tracking-widest mr-2 uppercase">اسم العمليات</label>
                    <Input value={form.opsName} onChange={e => handleInputChange("opsName", e.target.value)} className="rounded-2xl h-14 bg-black/40 border-[#d8b24a]/10 focus:border-[#d8b24a]/50 text-xl font-bold" />
                  </div>
                  <div className="space-y-3">
                    <label className="text-xs font-black text-[#d8b24a]/50 tracking-widest mr-2 uppercase">نائب العمليات</label>
                    <Input value={form.opsDeputy} onChange={e => handleInputChange("opsDeputy", e.target.value)} className="rounded-2xl h-14 bg-black/40 border-[#d8b24a]/10 focus:border-[#d8b24a]/50 text-xl font-bold" />
                  </div>
                </div>
                
                {["leaders", "officers", "ncos"].map(id => (
                  <div key={id} className="space-y-3">
                    <label className="text-xs font-black text-[#d8b24a]/50 tracking-widest mr-2 uppercase">
                      {id === "leaders" ? "القيادات العليا" : id === "officers" ? "قائمة الضباط" : "ضباط الصف"}
                    </label>
                    <Textarea 
                      value={form[id as keyof typeof form]} 
                      onChange={e => handleInputChange(id, e.target.value)} 
                      className="rounded-[2rem] bg-black/40 border-[#d8b24a]/10 min-h-[120px] resize-none p-5 text-lg" 
                    />
                  </div>
                ))}

                <div className="grid grid-cols-2 gap-6 pt-6 border-t border-[#d8b24a]/10">
                  <div className="space-y-3">
                    <label className="text-xs font-black text-[#d8b24a]/50 tracking-widest mr-2 uppercase">وقت الاستلام</label>
                    <div className="relative">
                      <Input value={form.recvTime} onChange={e => handleInputChange("recvTime", e.target.value)} className="rounded-2xl h-14 bg-black/40 border-[#d8b24a]/10 pr-14 text-xl font-mono" />
                      <Clock onClick={() => setTimeNow("recvTime")} className="absolute right-5 top-4.5 w-6 h-6 text-[#d8b24a] cursor-pointer hover:scale-125 transition-transform" />
                    </div>
                  </div>
                  <div className="space-y-3">
                    <label className="text-xs font-black text-[#d8b24a]/50 tracking-widest mr-2 uppercase">نهاية الاستلام</label>
                    <div className="relative">
                      <Input value={form.handoverTime} onChange={e => handleInputChange("handoverTime", e.target.value)} className="rounded-2xl h-14 bg-black/40 border-[#d8b24a]/10 pr-14 text-xl font-mono" />
                      <Clock onClick={() => setTimeNow("handoverTime")} className="absolute right-5 top-4.5 w-6 h-6 text-[#d8b24a] cursor-pointer hover:scale-125 transition-transform" />
                    </div>
                  </div>
                </div>
              </div>
            </Card>

            <Card className="p-10 bg-[#120d09]/90 border-[#d8b24a]/20 backdrop-blur-3xl rounded-[3rem] shadow-2xl">
              <h2 className="text-3xl font-black text-[#d8b24a] mb-8 flex items-center gap-4">
                <div className="p-3 bg-[#d8b24a]/10 rounded-2xl"><Zap className="w-8 h-8" /></div>
                توزيع فوري
              </h2>
              <Textarea 
                placeholder="أدخل الرموز هنا..."
                value={extractedInput}
                onChange={e => setExtractedInput(e.target.value)}
                className="rounded-[2rem] bg-black/40 border-[#d8b24a]/10 h-40 mb-8 p-6 text-xl"
              />
              <div className="space-y-3">
                {LANES_CONFIG.map(lane => (
                  <Button 
                    key={lane.id} 
                    onClick={() => distributeUnits(lane.id)} 
                    variant="ghost" 
                    className="w-full justify-between h-16 border border-[#d8b24a]/5 hover:bg-[#d8b24a]/10 rounded-2xl px-6 text-lg font-bold group"
                  >
                    <span className="group-hover:translate-x-[-10px] transition-transform">{lane.title}</span>
                    <PlusCircle className="w-6 h-6 text-[#d8b24a] opacity-50 group-hover:opacity-100 transition-opacity" />
                  </Button>
                ))}
              </div>
            </Card>
          </div>

          {/* Board Column */}
          <div className="lg:col-span-7 space-y-10">
            <div className="bg-black/50 border border-[#d8b24a]/20 rounded-[4rem] p-10 shadow-2xl backdrop-blur-3xl">
              <div className="flex flex-col md:flex-row justify-between items-center gap-8 mb-12">
                <h2 className="text-4xl font-black text-[#d8b24a]">لوحة القيادة والميدان</h2>
                <Button onClick={() => addUnit()} className="bg-[#d8b24a] text-black hover:bg-[#f1d58a] rounded-3xl h-16 px-14 font-black text-xl shadow-[0_15px_40px_rgba(216,178,74,0.4)] transition-all hover:scale-105 active:scale-95">
                  <PlusCircle className="w-6 h-6 ml-4" /> إضافة وحدة يدوياً
                </Button>
              </div>

              <div className="space-y-8">
                {LANES_CONFIG.map(lane => (
                  <div key={lane.id} className="rounded-[2.5rem] border border-[#d8b24a]/10 bg-[#15100a]/90 overflow-hidden shadow-xl">
                    <div className="p-8 flex justify-between items-center bg-gradient-to-r from-[#d8b24a]/15 via-[#d8b24a]/5 to-transparent border-b border-[#d8b24a]/10">
                      <div className="flex items-center gap-5">
                        <div className="w-2 h-10 bg-[#d8b24a] rounded-full shadow-[0_0_15px_#d8b24a]" />
                        <span className="text-2xl font-black text-[#f7f2e6]">{lane.title}</span>
                      </div>
                      <div className="bg-[#d8b24a]/10 text-[#d8b24a] px-6 py-2 rounded-full text-sm font-black ring-2 ring-[#d8b24a]/20">
                        {lanes[lane.id].length} وحدات نشطة
                      </div>
                    </div>
                    
                    <Reorder.Group 
                      axis="y" 
                      values={lanes[lane.id]} 
                      onReorder={(newOrder) => setLanes(prev => ({ ...prev, [lane.id]: newOrder }))}
                      className="p-6 space-y-4"
                    >
                      <AnimatePresence mode="popLayout">
                        {lanes[lane.id].map(unit => (
                          <Reorder.Item 
                            key={unit.id} 
                            value={unit}
                            initial={{ scale: 0.8, opacity: 0, x: -20 }}
                            animate={{ scale: 1, opacity: 1, x: 0 }}
                            exit={{ scale: 0.8, opacity: 0, x: 20 }}
                            whileDrag={{ scale: 1.05, boxShadow: "0 20px 40px rgba(0,0,0,0.6)", borderColor: "#d8b24a" }}
                            className="bg-black/60 border border-[#d8b24a]/10 p-5 rounded-3xl flex items-center gap-6 group hover:bg-[#d8b24a]/5 transition-all cursor-default relative overflow-hidden"
                          >
                            <div className="absolute left-0 top-0 bottom-0 w-1 bg-transparent group-hover:bg-[#d8b24a] transition-colors" />
                            <div className="cursor-grab active:cursor-grabbing p-2 text-[#d8b24a]/30 group-hover:text-[#d8b24a] transition-colors">
                              <GripVertical className="w-7 h-7" />
                            </div>
                            <Input 
                              value={unit.text} 
                              onChange={e => updateUnitText(lane.id, unit.id, e.target.value)} 
                              className="bg-transparent border-none text-2xl font-black text-[#d8b24a] h-auto p-0 placeholder:text-[#d8b24a]/10"
                              placeholder="أدخل كود الوحدة..."
                            />
                            <Button 
                              variant="ghost" 
                              size="icon" 
                              className="w-12 h-12 text-red-500/20 hover:text-red-500 hover:bg-red-500/10 rounded-2xl"
                              onClick={() => deleteUnit(lane.id, unit.id)}
                            >
                              <Trash2 className="w-6 h-6" />
                            </Button>
                          </Reorder.Item>
                        ))}
                      </AnimatePresence>
                      {lanes[lane.id].length === 0 && (
                        <motion.div 
                          className="flex flex-col items-center justify-center p-16 text-[#d8b24a]/10 border-2 border-dashed border-[#d8b24a]/5 rounded-[2rem]"
                          initial={{ opacity: 0 }} animate={{ opacity: 1 }}
                        >
                           <ShieldCheck className="w-16 h-16 mb-4 opacity-10 animate-pulse" />
                           <p className="text-sm font-black uppercase tracking-[0.3em]">بانتظار توزيع القوات</p>
                        </motion.div>
                      )}
                    </Reorder.Group>
                  </div>
                ))}
              </div>
            </div>

            {/* Final Report Card */}
            <Card className="p-12 bg-gradient-to-br from-[#1c160e] to-[#0b0805] border-[#d8b24a]/40 rounded-[4rem] shadow-[0_50px_100px_rgba(0,0,0,0.9)] relative overflow-hidden group">
              <div className="absolute top-0 right-0 w-64 h-64 bg-[#d8b24a]/5 blur-[100px] pointer-events-none" />
              <h2 className="text-4xl font-black text-[#d8b24a] mb-10 flex items-center gap-5">
                <Copy className="w-8 h-8" />
                معاينة التقرير الاستراتيجي
              </h2>
              <Textarea 
                readOnly 
                value={buildReport()} 
                className="bg-black/60 border-[#d8b24a]/10 min-h-[500px] font-mono text-xl leading-loose mb-10 rounded-[2.5rem] p-10 focus:ring-0 selection:bg-[#d8b24a] selection:text-black shadow-inner" 
              />
              <Button onClick={copyReport} className="w-full h-24 rounded-[3rem] bg-[#d8b24a] text-black hover:bg-[#f1d58a] font-black text-3xl shadow-[0_25px_60px_rgba(216,178,74,0.4)] transition-all active:scale-95 group">
                <Copy className="w-8 h-8 ml-5 group-hover:rotate-12 transition-transform" /> 
                نسخ التقرير للنظام
              </Button>
            </Card>
          </div>
        </main>
      </div>
    </div>
  );
}
